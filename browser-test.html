<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‹…ä¿äº¤æ˜“ç¾¤åŠŸèƒ½æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .test-section {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #007bff;
        }
        .success {
            border-left-color: #28a745;
            background: #d4edda;
        }
        .warning {
            border-left-color: #ffc107;
            background: #fff3cd;
        }
        .error {
            border-left-color: #dc3545;
            background: #f8d7da;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>ğŸ” æ‹…ä¿äº¤æ˜“ç¾¤åŠŸèƒ½æµ‹è¯•</h1>
    
    <div class="test-section">
        <h2>ğŸ“Š æµ‹è¯•ç»“æœ</h2>
        <div id="test-results"></div>
        <button onclick="runTests()">ğŸš€ è¿è¡Œæµ‹è¯•</button>
        <button onclick="clearData()">ğŸ—‘ï¸ æ¸…é™¤æµ‹è¯•æ•°æ®</button>
        <button onclick="createTestData()">ğŸ“ åˆ›å»ºæµ‹è¯•æ•°æ®</button>
    </div>

    <div class="test-section">
        <h2>ğŸ“‹ å½“å‰æ•°æ®çŠ¶æ€</h2>
        <div id="data-status"></div>
    </div>

    <div class="test-section">
        <h2>ğŸ¯ å¿«é€Ÿè®¿é—®</h2>
        <p><a href="http://localhost:3007" target="_blank">ğŸŒ æ‰“å¼€åº”ç”¨</a></p>
        <p><strong>ç®¡ç†å‘˜è´¦å·ï¼š</strong> 18800000001 / 123456</p>
    </div>

    <script>
        function runTests() {
            const results = document.getElementById('test-results');
            results.innerHTML = '<h3>ğŸ” æ­£åœ¨æµ‹è¯•...</h3>';
            
            setTimeout(() => {
                let html = '';
                
                // æµ‹è¯•1: æ£€æŸ¥chatList
                const chatList = JSON.parse(localStorage.getItem('chatList') || '[]');
                const guaranteeGroups = chatList.filter(chat => chat.isGuarantee);
                
                if (guaranteeGroups.length > 0) {
                    html += `<div class="test-section success">
                        <h3>âœ… æµ‹è¯•1: æ‹…ä¿äº¤æ˜“ç¾¤æ•°æ®</h3>
                        <p>æ‰¾åˆ° ${guaranteeGroups.length} ä¸ªæ‹…ä¿äº¤æ˜“ç¾¤</p>
                        <ul>
                            ${guaranteeGroups.map(group => `<li>${group.name} (${group.id})</li>`).join('')}
                        </ul>
                    </div>`;
                } else {
                    html += `<div class="test-section error">
                        <h3>âŒ æµ‹è¯•1: æ‹…ä¿äº¤æ˜“ç¾¤æ•°æ®</h3>
                        <p>æ²¡æœ‰æ‰¾åˆ°æ‹…ä¿äº¤æ˜“ç¾¤æ•°æ®</p>
                    </div>`;
                }
                
                // æµ‹è¯•2: æ£€æŸ¥orders
                const orders = JSON.parse(localStorage.getItem('orders') || '[]');
                const guaranteeOrders = orders.filter(order => 
                    guaranteeGroups.some(group => group.id === order.id)
                );
                
                if (guaranteeOrders.length > 0) {
                    html += `<div class="test-section success">
                        <h3>âœ… æµ‹è¯•2: æ‹…ä¿è®¢å•æ•°æ®</h3>
                        <p>æ‰¾åˆ° ${guaranteeOrders.length} ä¸ªæ‹…ä¿è®¢å•</p>
                        <ul>
                            ${guaranteeOrders.map(order => `<li>${order.title} - ${order.status}</li>`).join('')}
                        </ul>
                    </div>`;
                } else {
                    html += `<div class="test-section warning">
                        <h3>âš ï¸ æµ‹è¯•2: æ‹…ä¿è®¢å•æ•°æ®</h3>
                        <p>æ²¡æœ‰æ‰¾åˆ°å¯¹åº”çš„æ‹…ä¿è®¢å•</p>
                    </div>`;
                }
                
                // æµ‹è¯•3: æ£€æŸ¥èŠå¤©æ¶ˆæ¯
                let messageCount = 0;
                guaranteeGroups.forEach(group => {
                    const messages = JSON.parse(localStorage.getItem(`chat_messages_${group.id}`) || '[]');
                    messageCount += messages.length;
                });
                
                html += `<div class="test-section success">
                    <h3>âœ… æµ‹è¯•3: èŠå¤©æ¶ˆæ¯æ•°æ®</h3>
                    <p>æ€»å…± ${messageCount} æ¡èŠå¤©æ¶ˆæ¯</p>
                </div>`;
                
                results.innerHTML = html;
                updateDataStatus();
            }, 500);
        }
        
        function clearData() {
            if (confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰æµ‹è¯•æ•°æ®å—ï¼Ÿ')) {
                localStorage.removeItem('chatList');
                localStorage.removeItem('orders');
                
                // æ¸…é™¤èŠå¤©æ¶ˆæ¯
                for (let i = localStorage.length - 1; i >= 0; i--) {
                    const key = localStorage.key(i);
                    if (key && key.startsWith('chat_messages_')) {
                        localStorage.removeItem(key);
                    }
                }
                
                updateDataStatus();
                alert('æµ‹è¯•æ•°æ®å·²æ¸…é™¤');
            }
        }
        
        function createTestData() {
            // åˆ›å»ºæµ‹è¯•æ‹…ä¿ç¾¤
            const testGroups = [
                {
                    id: 'test_guarantee_1',
                    name: 'ç‹è€…è£è€€æ®µä½æ‹…ä¿ç¾¤',
                    avatar: 'https://picsum.photos/seed/game1/40/40.jpg',
                    lastMessage: 'ç®¡ç†å‘˜å·²ç¡®è®¤æ”¶æ¬¾ï¼Œå¼€å§‹ä»£ç»ƒæœåŠ¡',
                    lastTime: '10:30',
                    unreadCount: 0,
                    isGroup: true,
                    isGuarantee: true,
                    members: [
                        { name: 'ç©å®¶å°æ', avatar: 'https://picsum.photos/seed/player1/40/40.jpg', role: 'buyer' },
                        { name: 'ä»£ç»ƒå¸ˆå°ç‹', avatar: 'https://picsum.photos/seed/seller1/40/40.jpg', role: 'seller' },
                        { name: 'ç®¡ç†å‘˜', avatar: 'https://picsum.photos/seed/admin/40/40.jpg', role: 'admin' }
                    ]
                },
                {
                    id: 'test_guarantee_2', 
                    name: 'å’Œå¹³ç²¾è‹±è£…å¤‡æ‹…ä¿ç¾¤',
                    avatar: 'https://picsum.photos/seed/game2/40/40.jpg',
                    lastMessage: 'ç­‰å¾…ä¹°å®¶ç¡®è®¤æ”¶è´§',
                    lastTime: '09:15',
                    unreadCount: 2,
                    isGroup: true,
                    isGuarantee: true,
                    members: [
                        { name: 'ä¹°å®¶å°å¼ ', avatar: 'https://picsum.photos/seed/player2/40/40.jpg', role: 'buyer' },
                        { name: 'å–å®¶å°é™ˆ', avatar: 'https://picsum.photos/seed/seller2/40/40.jpg', role: 'seller' },
                        { name: 'ç®¡ç†å‘˜', avatar: 'https://picsum.photos/seed/admin/40/40.jpg', role: 'admin' }
                    ]
                },
                {
                    id: 'test_guarantee_3',
                    name: 'åŸç¥è´¦å·æ‹…ä¿ç¾¤', 
                    avatar: 'https://picsum.photos/seed/game3/40/40.jpg',
                    lastMessage: 'è´¦å·äº¤æ˜“å·²å®Œæˆï¼Œèµ„é‡‘å·²é‡Šæ”¾',
                    lastTime: 'æ˜¨å¤©',
                    unreadCount: 0,
                    isGroup: true,
                    isGuarantee: true,
                    members: [
                        { name: 'ä¹°å®¶å°åˆ˜', avatar: 'https://picsum.photos/seed/player3/40/40.jpg', role: 'buyer' },
                        { name: 'å–å®¶å°èµµ', avatar: 'https://picsum.photos/seed/seller3/40/40.jpg', role: 'seller' },
                        { name: 'ç®¡ç†å‘˜', avatar: 'https://picsum.photos/seed/admin/40/40.jpg', role: 'admin' }
                    ]
                }
            ];
            
            // ä¿å­˜åˆ°èŠå¤©åˆ—è¡¨
            const chatList = JSON.parse(localStorage.getItem('chatList') || '[]');
            testGroups.forEach(group => {
                if (!chatList.find(chat => chat.id === group.id)) {
                    chatList.push(group);
                }
                
                // åˆ›å»ºèŠå¤©æ¶ˆæ¯
                const messages = createGroupMessages(group);
                localStorage.setItem(`chat_messages_${group.id}`, JSON.stringify(messages));
            });
            localStorage.setItem('chatList', JSON.stringify(chatList));
            
            // ä¿å­˜åˆ°è®¢å•åˆ—è¡¨
            const orders = JSON.parse(localStorage.getItem('orders') || '[]');
            testGroups.forEach(group => {
                if (!orders.find(order => order.id === group.id)) {
                    orders.push({
                        id: group.id,
                        title: group.name,
                        status: group.id === 'test_guarantee_1' ? 'confirmed' : group.id === 'test_guarantee_2' ? 'pending' : 'completed',
                        amount: group.id === 'test_guarantee_1' ? '200' : group.id === 'test_guarantee_2' ? '150' : '300',
                        createdAt: new Date().toISOString()
                    });
                }
            });
            localStorage.setItem('orders', JSON.stringify(orders));
            
            updateDataStatus();
            alert('æµ‹è¯•æ•°æ®åˆ›å»ºæˆåŠŸï¼');
        }
        
        function createGroupMessages(group) {
            const baseMessages = [
                {
                    id: 1,
                    sender: 'ç³»ç»Ÿæ¶ˆæ¯',
                    content: `${group.name} å·²åˆ›å»º`,
                    time: '09:00',
                    isSelf: false,
                    avatar: 'https://picsum.photos/seed/system/40/40.jpg',
                    showTime: true,
                    isSystem: true
                },
                {
                    id: 2,
                    sender: 'ç³»ç»Ÿæ¶ˆæ¯',
                    content: 'ç®¡ç†å‘˜å·²è‡ªåŠ¨åŠ å…¥ç¾¤èŠ',
                    time: '09:01',
                    isSelf: false,
                    avatar: 'https://picsum.photos/seed/system/40/40.jpg',
                    isSystem: true
                },
                {
                    id: 3,
                    sender: 'ç®¡ç†å‘˜',
                    content: 'å¤§å®¶å¥½ï¼Œæˆ‘æ˜¯ç®¡ç†å‘˜ã€‚æ‹…ä¿äº¤æ˜“å·²åˆ›å»ºï¼Œè¯·æŒ‰ç…§æµç¨‹æ“ä½œã€‚',
                    time: '09:02',
                    isSelf: false,
                    avatar: 'https://picsum.photos/seed/admin/40/40.jpg',
                    isAdmin: true
                }
            ];
            
            // æ ¹æ®ç¾¤çŠ¶æ€æ·»åŠ ä¸åŒçš„æ¶ˆæ¯
            if (group.id === 'test_guarantee_1') {
                baseMessages.push(
                    {
                        id: 4,
                        sender: 'ç©å®¶å°æ',
                        content: 'å·²æ”¯ä»˜ï¼Œè¯·ç¡®è®¤',
                        time: '10:00',
                        isSelf: false,
                        avatar: 'https://picsum.photos/seed/player1/40/40.jpg'
                    },
                    {
                        id: 5,
                        sender: 'ç®¡ç†å‘˜',
                        content: 'âœ… æ”¶æ¬¾ç¡®è®¤æˆåŠŸï¼\n\nğŸ“‹ èµ„é‡‘åˆ°è´¦ä¿¡æ¯ï¼š\nâ€¢ æ”¯ä»˜çŠ¶æ€ï¼šå·²åˆ°è´¦ âœ“\nâ€¢ èµ„é‡‘é‡‘é¢ï¼šå·²æ ¸å® âœ“\nâ€¢ æ‹…ä¿çŠ¶æ€ï¼šç”Ÿæ•ˆä¸­ âœ“',
                        time: '10:30',
                        isSelf: false,
                        avatar: 'https://picsum.photos/seed/admin/40/40.jpg',
                        isAdmin: true
                    }
                );
            }
            
            return baseMessages;
        }
        
        function updateDataStatus() {
            const status = document.getElementById('data-status');
            const chatList = JSON.parse(localStorage.getItem('chatList') || '[]');
            const orders = JSON.parse(localStorage.getItem('orders') || '[]');
            const guaranteeGroups = chatList.filter(chat => chat.isGuarantee);
            
            let messageCount = 0;
            guaranteeGroups.forEach(group => {
                const messages = JSON.parse(localStorage.getItem(`chat_messages_${group.id}`) || '[]');
                messageCount += messages.length;
            });
            
            status.innerHTML = `
                <p><strong>èŠå¤©åˆ—è¡¨ï¼š</strong> ${chatList.length} ä¸ªç¾¤èŠ</p>
                <p><strong>æ‹…ä¿äº¤æ˜“ç¾¤ï¼š</strong> ${guaranteeGroups.length} ä¸ª</p>
                <p><strong>è®¢å•æ•°é‡ï¼š</strong> ${orders.length} ä¸ª</p>
                <p><strong>èŠå¤©æ¶ˆæ¯ï¼š</strong> ${messageCount} æ¡</p>
                <details>
                    <summary>è¯¦ç»†æ•°æ®</summary>
                    <pre>${JSON.stringify({ chatList, orders }, null, 2)}</pre>
                </details>
            `;
        }
        
        // é¡µé¢åŠ è½½æ—¶æ›´æ–°çŠ¶æ€
        window.onload = function() {
            updateDataStatus();
        };
    </script>
</body>
</html>